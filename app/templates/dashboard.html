{% extends 'base.html' %} 
{% set title = '‡∏™‡∏£‡∏∏‡∏õ' %}

{% block content %}
<style>
  .dashFilters{
    display:flex; gap:10px; flex-wrap:wrap; align-items:end; justify-content:space-between;
  }
  .dashFilters .left{ display:flex; gap:10px; flex-wrap:wrap; }
  .btn{ min-height:44px; }
  .input{ min-height:44px; }

  .kpiGrid{
    display:grid;
    grid-template-columns: repeat(6, 1fr); /* ‚úÖ ‡∏à‡∏≤‡∏Å 4 -> 6 ‡∏ä‡πà‡∏≠‡∏á */
    gap:12px;
  }
  .kpi{
    border: 1px solid rgba(255,255,255,.08);
    background: rgba(10,15,25,.35);
    border-radius: 16px;
    padding: 12px 14px;
  }
  .kpi .k{ font-size:12px; opacity:.75; }
  .kpi .v{ font-size:22px; font-weight:800; margin-top:4px; }

  /* ‚úÖ ‡∏™‡∏µ ‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô */
  .pl-pos{ color: rgba(120, 255, 180, .95); }
  .pl-neg{ color: rgba(255, 140, 140, .95); }

  .table-wrap{ overflow-x:auto; -webkit-overflow-scrolling:touch; border-radius:14px; }
  .table{ min-width: 820px; }

  @media (max-width: 1100px){
    .kpiGrid{ grid-template-columns: 1fr 1fr 1fr; } /* 3 ‡∏ä‡πà‡∏≠‡∏á/‡πÅ‡∏ñ‡∏ß */
  }
  @media (max-width: 860px){
    .kpiGrid{ grid-template-columns: 1fr 1fr; } /* 2 ‡∏ä‡πà‡∏≠‡∏á/‡πÅ‡∏ñ‡∏ß */
  }
</style>

<div class="pagehead">
  <div>
    <h1>‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</h1>
    <div class="muted">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏° ‚Äú‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‚Äù (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ)</div>
  </div>
</div>

<div class="card">
  <form class="dashFilters" method="get" action="{{ url_for('pages.dashboard') }}">
    <div class="left">
      <div>
        <label class="label">‡∏õ‡∏µ</label>
        <select class="input" name="year">
          {% for y in years %}
            <option value="{{ y }}" {{ 'selected' if y==year else '' }}>{{ y }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="label">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
        <select class="input" name="month">
          <option value="" {{ 'selected' if not month else '' }}>‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏µ</option>
          {% for m in range(1,13) %}
            <option value="{{ m }}" {{ 'selected' if month==m else '' }}>{{ "%02d"|format(m) }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <button class="btn btn-primary" type="submit">üîé ‡∏î‡∏π‡∏ú‡∏•</button>
      </div>
    </div>

    <div>
      <a class="btn" href="{{ url_for('pages.dashboard_export_xlsx', year=year, month=month or '') }}">‚¨áÔ∏è Export Excel</a>
    </div>
  </form>
</div>

<div class="kpiGrid mt-12">
  <div class="kpi">
    <div class="k">‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏£‡∏ß‡∏°</div>
    <div class="v mono">{{ '%.2f'|format(totals.materials or 0) }}</div>
  </div>
  <div class="kpi">
    <div class="k">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡∏ä‡πà‡∏ß‡∏á‡∏£‡∏ß‡∏° (‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á)</div>
    <div class="v mono">{{ '%.2f'|format(totals.subs or 0) }}</div>
  </div>
  <div class="kpi">
    <div class="k">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô‡∏£‡∏ß‡∏°</div>
    <div class="v mono">{{ '%.2f'|format(totals.expenses or 0) }}</div>
  </div>
  <div class="kpi">
    <div class="k">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
    <div class="v mono">{{ '%.2f'|format(totals.grand or 0) }}</div>
  </div>

  {# ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏ß‡∏° (‡∏à‡∏≤‡∏Å QT APPROVED) #}
  <div class="kpi">
    <div class="k">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏ß‡∏°</div>
    <div class="v mono">{{ '%.2f'|format(total_income or 0) }}</div>
  </div>

  {# ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏° = ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏ß‡∏° - ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î #}
  {% set pl = (profit_loss or 0) %}
  <div class="kpi">
    <div class="k">‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô</div>
    <div class="v mono">
      <span class="{{ 'pl-neg' if pl < 0 else 'pl-pos' }}">
        {{ '%.2f'|format(pl) }}
      </span>
    </div>
  </div>
</div>

<div class="card mt-12">
  <div class="section-head">
    <div>
      <div class="section-title">Top 5 ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</div>
      <div class="muted">‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á</div>
    </div>
  </div>

  <div class="table-wrap">
    <table class="table">
      <thead>
        <tr>
          <th>‡∏£‡∏´‡∏±‡∏™</th>
          <th>‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</th>
          <th class="right">‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏™‡∏î‡∏∏</th>
          <th class="right">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡∏ä‡πà‡∏ß‡∏á</th>
          <th class="right">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</th>
          <th class="right">‡∏£‡∏ß‡∏°</th>
        </tr>
      </thead>
      <tbody>
        {% if top5 %}
          {% for row in top5 %}
          <tr>
            <td class="mono">{{ row['code'] }}</td>
            <td>{{ row['name'] }}</td>
            <td class="right mono">{{ '%.2f'|format(row['materials'] or 0) }}</td>
            <td class="right mono">{{ '%.2f'|format(row['subs'] or 0) }}</td>
            <td class="right mono">{{ '%.2f'|format(row['expenses'] or 0) }}</td>
            <td class="right mono" style="font-weight:800;">{{ '%.2f'|format(row['total'] or 0) }}</td>
          </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="6" class="muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

{% endblock %}
