<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />

  <!-- ‚úÖ PWA / Mobile viewport fix -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- ‚úÖ Theme -->
  <meta name="theme-color" content="#0b1220" />

  <!-- ‚úÖ iOS PWA support -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Contractor Tracker" />

  <!-- ‚úÖ Android PWA hint -->
  <meta name="mobile-web-app-capable" content="yes" />

  <title>{{ title or "Contractor Project Tracker" }}</title>

  <link rel="manifest" href="{{ url_for('static', filename='pwa/manifest.json') }}">
  <link rel="icon" href="{{ url_for('static', filename='icons/icon-192.png') }}">

  <link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}">

  <!-- ‚úÖ Emergency CSS fix (until you send app.css)
       - ‡∏Å‡∏±‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤ 100vh ‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠/PWA
       - ‡∏Å‡∏±‡∏ô safe-area (notch/home bar) ‡∏ó‡∏≥‡πÉ‡∏´‡πâ layout ‡∏î‡∏π‡πÇ‡∏î‡∏ô‡∏î‡∏±‡∏ô -->
  <style>
    :root{
      --safe-top: env(safe-area-inset-top);
      --safe-right: env(safe-area-inset-right);
      --safe-bottom: env(safe-area-inset-bottom);
      --safe-left: env(safe-area-inset-left);

      /* ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å set ‡πÇ‡∏î‡∏¢ JS ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á */
      --app-vh: 1vh;
    }

    html, body{
      height: auto;
      min-height: 100%;
    }

    body{
      min-height: 100dvh; /* modern mobile */
      padding-bottom: var(--safe-bottom);
      -webkit-text-size-adjust: 100%;
    }

    /* ‡∏ñ‡πâ‡∏≤ topbar ‡πÄ‡∏õ‡πá‡∏ô fixed/sticky ‡πÅ‡∏•‡πâ‡∏ß‡∏ä‡∏¥‡∏î‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ‡∏ö‡∏ô iOS */
    .topbar{
      padding-top: var(--safe-top);
    }

    /* Container ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ä‡∏ô safe area ‡∏ã‡πâ‡∏≤‡∏¢/‡∏Ç‡∏ß‡∏≤ */
    .container{
      padding-left: max(16px, var(--safe-left));
      padding-right: max(16px, var(--safe-right));
    }

    /* ‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏ô/‡∏Ç‡∏¢‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏Ñ‡∏µ‡∏¢‡πå‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏ö‡∏≤‡∏á‡∏£‡∏∏‡πà‡∏ô */
    body.drawer-open{
      overscroll-behavior: none;
      touch-action: manipulation;
    }
  </style>

  {% block head %}{% endblock %}
</head>
<body>
  <!-- Drawer backdrop -->
  <div class="drawer-backdrop" data-drawer-close></div>

  <!-- Drawer (‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≠‡∏°) -->
  <aside class="drawer" aria-label="‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å" aria-hidden="true">
    <div class="drawer__head">
      <div class="drawer__brand">
        <img src="{{ url_for('static', filename='icons/icon-192.png') }}" alt="" class="drawer__icon">
        <div>
          <div class="drawer__title">Contractor Tracker</div>
          <div class="drawer__subtitle">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ ‚Ä¢ ‡∏ß‡∏±‡∏™‡∏î‡∏∏ ‚Ä¢ ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡∏ä‡πà‡∏ß‡∏á</div>
        </div>
      </div>
      <button class="drawer__close" type="button" aria-label="‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π" data-drawer-close>‚úï</button>
    </div>

    <nav class="drawer__nav">
      <a class="drawer__link {{ 'is-active' if request.path.startswith('/projects') else '' }}" href="{{ url_for('pages.project_list') }}">
        <span class="drawer__emoji">üìÅ</span>
        <span>‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</span>
      </a>
      <a class="drawer__link {{ 'is-active' if request.path == '/dashboard' else '' }}" href="{{ url_for('pages.dashboard') }}">
        <span class="drawer__emoji">üìä</span>
        <span>‡∏™‡∏£‡∏∏‡∏õ</span>
      </a>
      <a class="drawer__link {{ 'is-active' if request.path.startswith('/dashboard/income') else '' }}" href="{{ url_for('pages.dashboard_income') }}">
        <span class="drawer__emoji">üí∞</span>
        <span>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</span>
      </a>
      <a class="drawer__link {{ 'is-active' if request.path.startswith('/dashboard/expense') else '' }}" href="{{ url_for('pages.dashboard_expense') }}">
        <span class="drawer__emoji">üí∏</span>
        <span>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</span>
      </a>
      <a class="drawer__link {{ 'is-active' if request.path.startswith('/docs') else '' }}" href="{{ url_for('docs.docs_list') }}">
        <span class="drawer__emoji">üßæ</span>
        <span>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</span>
      </a>
      <a class="drawer__link {{ 'is-active' if request.path.startswith('/customers') else '' }}" href="{{ url_for('customers.customers_list') }}">
        <span class="drawer__emoji">üë•</span>
        <span>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</span>
      </a>
      <a class="drawer__link {{ 'is-active' if request.path.startswith('/settings/company') else '' }}" href="{{ url_for('settings.company_settings') }}">
        <span class="drawer__emoji">üè¢</span>
        <span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</span>
      </a>
    </nav>

    <div class="drawer__footer">
      <div class="muted" style="font-size:12px;">
        ‡∏ó‡∏¥‡∏õ: ‡∏Å‡∏î‡πÄ‡∏°‡∏ô‡∏π ‚ò∞ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤
      </div>
    </div>
  </aside>

  <header class="topbar">
    <div class="topbar__inner">
      <button class="hamburger" type="button" aria-label="‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π" data-drawer-open>
        <span class="hamburger__bar"></span>
        <span class="hamburger__bar"></span>
        <span class="hamburger__bar"></span>
      </button>

      <div class="brand">
        <img src="{{ url_for('static', filename='icons/icon-192.png') }}" alt="" class="brand__icon">
        <div class="brand__text">
          <div class="brand__title">Contractor Tracker</div>
          <div class="brand__subtitle">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ ‚Ä¢ ‡∏ß‡∏±‡∏™‡∏î‡∏∏ ‚Ä¢ ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡∏ä‡πà‡∏ß‡∏á</div>
        </div>
      </div>
    </div>
  </header>

  <main class="container">

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div style="margin: 12px 0; display:flex; flex-direction:column; gap:8px;">
          {% for cat, msg in messages %}
            <div class="alert alert--{{ cat }}">{{ msg }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}
  </main>

  <script>
    (function(){
      // ‚úÖ Mobile viewport height fix (PWA/Chrome/iOS): set --app-vh
      function setAppVh(){
        var vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--app-vh', vh + 'px');
      }
      setAppVh();
      window.addEventListener('resize', setAppVh);
      window.addEventListener('orientationchange', setAppVh);

      const body = document.body;
      const openBtn = document.querySelector('[data-drawer-open]');
      const closeEls = document.querySelectorAll('[data-drawer-close]');
      const drawer = document.querySelector('.drawer');

      function openDrawer(){
        body.classList.add('drawer-open');
        if(drawer) drawer.setAttribute('aria-hidden','false');
      }
      function closeDrawer(){
        body.classList.remove('drawer-open');
        if(drawer) drawer.setAttribute('aria-hidden','true');
      }

      if(openBtn){ openBtn.addEventListener('click', openDrawer); }
      closeEls.forEach(el => el.addEventListener('click', closeDrawer));

      document.addEventListener('keydown', function(e){
        if(e.key === 'Escape') closeDrawer();
      });
    })();
  </script>

  <script src="{{ url_for('static', filename='js/pwa.js') }}"></script>
  {% block scripts %}{% endblock %}
</body>
</html>
