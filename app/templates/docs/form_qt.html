{% extends "base.html" %}
{% set title = "สร้างใบเสนอราคา" %}

{% block content %}
<div class="pagehead">
  <div>
    <h1>สร้างใบเสนอราคา (QT)</h1>
    <div class="muted">เลขเอกสารอัตโนมัติ + รายการเป็นข้อความล้วน</div>
  </div>
  <div class="actions">
    <a class="btn btn-ghost" href="{{ url_for('docs.docs_list') }}">กลับ</a>
  </div>
</div>

<div class="card">
  {# ✅ สำคัญ: ต้องมี enctype เพื่ออัปโหลดไฟล์ #}
  <form method="post" class="form" enctype="multipart/form-data">
    <div class="grid grid-2">
      <label class="field">
        <span>เลขเอกสาร</span>
        <input name="doc_no" value="{{ doc_no }}" class="input">
      </label>

      <label class="field">
        <span>วันที่ออกเอกสาร</span>
        <input value="{{ today }}" class="input" disabled>
      </label>

      
      <input type="hidden" name="customer_id" id="customer_id" value="">
      <label class="field" style="grid-column:1/-1; position:relative;">
        <span>ค้นหาลูกค้า (พิมพ์ชื่อแล้วเลือก)</span>
        <input id="customer_search" class="input" placeholder="พิมพ์ชื่อ เช่น บริษัท... / คุณ..." autocomplete="off">
        <div id="customer_suggest" class="suggest" style="display:none;"></div>
      </label>

      <label class="field" style="grid-column:1/-1;">
        <span>ชื่อลูกค้า *</span>
        <input name="customer_name" id="customer_name" class="input" required>
      </label>


      <label class="field">
        <span>เลขผู้เสียภาษีลูกค้า</span>
        <input name="customer_tax_id" class="input">
      </label>

      <label class="field">
        <span>โทรศัพท์ลูกค้า</span>
        <input name="customer_phone" class="input">
      </label>

      <label class="field">
        <span>อีเมลลูกค้า</span>
        <input name="customer_email" class="input">
      </label>

      <label class="field" style="grid-column:1/-1;">
        <span>ที่อยู่ลูกค้า</span>
        <textarea name="customer_address" rows="3"></textarea>
      </label>

      <label class="field" style="grid-column:1/-1;">
        <span>หัวเรื่อง</span>
        <input name="subject" class="input" placeholder="เช่น งานติดตั้ง / งานรีโนเวท / งานระบบไฟฟ้า">
      </label>

      <label class="field" style="grid-column:1/-1;">
        <span>รายละเอียดงาน</span>
        <textarea name="description" rows="3"></textarea>
      </label>
    </div>

    {# ---------------------------------------------------------
       ✅ แนบไฟล์ BOQ (Excel / PDF) - ไม่กระทบหน้า print
       - ฝั่ง backend จะรับ request.files['boq_excel'], ['boq_pdf']
       - ไม่แสดงชื่อไฟล์ในเอกสารพิมพ์ (เราไม่ได้เอาไปโชว์ที่ print)
       --------------------------------------------------------- #}
    <div class="mt-12">
      <div class="section-head">
        <div class="section-title">แนบไฟล์ BOQ (ไม่บังคับ)</div>
        <div class="muted">แนบเพื่ออ้างอิงภายในระบบ (ไม่แสดงในเอกสารพิมพ์)</div>
      </div>

      <div class="grid grid-2">
        <label class="field">
          <span>BOQ (Excel)</span>
          <input class="input" type="file" name="boq_excel" accept=".xls,.xlsx,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet">
          <div class="muted" style="margin-top:6px;">รองรับ .xls / .xlsx</div>
        </label>

        <label class="field">
          <span>BOQ (PDF)</span>
          <input class="input" type="file" name="boq_pdf" accept=".pdf,application/pdf">
          <div class="muted" style="margin-top:6px;">รองรับ .pdf</div>
        </label>
      </div>
    </div>

    <div class="mt-12">
      <div class="section-head">
        <div class="section-title">รายการ</div>
        <div class="muted">กรอกอย่างน้อย 1 รายการ</div>
      </div>

      <div class="table-wrap">
        <table class="table" id="itemsTable">
          <thead>
            <tr>
              <th>รายละเอียด</th>
              <th style="width:120px;" class="right">จำนวน</th>
              <th style="width:160px;" class="right">ราคาต่อหน่วย</th>
              <th style="width:140px;" class="right">ส่วนลด</th>
              <th style="width:90px;" class="center">ลบ</th>
            </tr>
          </thead>
          <tbody>
            {% for it in items %}
            <tr>
              <td><input class="input" name="item_description" value="{{ it.description }}"></td>
              <td><input class="input right" name="item_qty" value="{{ it.qty }}"></td>
              <td><input class="input right" name="item_unit_price" value="{{ it.unit_price }}"></td>
              <td><input class="input right" name="item_discount_amount" value="{{ it.discount_amount }}"></td>
              <td class="center"><button class="row-btn" type="button" onclick="removeRow(this)">✖</button></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="actions mt-12">
        <button class="btn btn-small" type="button" onclick="addRow()">+ เพิ่มรายการ</button>
      </div>
    </div>

    <div class="mt-12 grid grid-3">
      <label class="field">
        <span>ส่วนลดท้ายบิล</span>
        <input name="discount_amount" class="input right" value="0">
      </label>
      <label class="field">
        <span>VAT (%)</span>
        <input name="vat_rate" class="input right" value="7">
      </label>
      <label class="field">
        <span>หัก ณ ที่จ่าย (%)</span>
        <input name="wht_rate" class="input right" value="0">
      </label>

      <label class="field" style="grid-column:1/-1;">
        <span>เงื่อนไขเงินประกัน</span>
        <textarea name="deposit_note" rows="2"></textarea>
      </label>

      <label class="field">
        <span>ระยะเวลารับประกัน (เดือน)</span>
        <input name="warranty_months" class="input" placeholder="เช่น 12">
      </label>

      <label class="field" style="grid-column:1/-1;">
        <span>เงื่อนไขการชำระเงิน</span>
        <textarea name="payment_terms" rows="2"></textarea>
      </label>

      <label class="field" style="grid-column:1/-1;">
        <span>หมายเหตุ</span>
        <textarea name="note" rows="2"></textarea>
      </label>
    </div>

    <div class="actions mt-12">
      <button class="btn btn-primary" type="submit">บันทึกใบเสนอราคา</button>
      <a class="btn btn-ghost" href="{{ url_for('docs.docs_list') }}">ยกเลิก</a>
    </div>
  </form>
</div>

<style>
  .suggest{
    position:absolute;
    left:0; right:0;
    top: calc(100% + 6px);
    background: rgba(20, 26, 38, .98);
    border: 1px solid rgba(255,255,255,.10);
    border-radius: 14px;
    box-shadow: 0 18px 50px rgba(0,0,0,.25);
    overflow: hidden;
    z-index: 50;
  }
  .suggest button{
    display:block;
    width:100%;
    text-align:left;
    padding:10px 12px;
    background: transparent;
    border:0;
    color: #e6eefc;
    cursor:pointer;
  }
  .suggest button:hover{
    background: rgba(255,255,255,.06);
  }
  .suggest .muted{
    display:block;
    font-size:12px;
    opacity:.75;
    margin-top:2px;
  }
</style>

<script>
(function(){
  const $search = document.getElementById('customer_search');
  const $box = document.getElementById('customer_suggest');
  const $cid = document.getElementById('customer_id');

  const $name = document.getElementById('customer_name');
  const $tax = document.querySelector('[name="customer_tax_id"]');
  const $phone = document.querySelector('[name="customer_phone"]');
  const $email = document.querySelector('[name="customer_email"]');
  const $addr = document.querySelector('[name="customer_address"]');

  let t = null;

  function hideBox(){ $box.style.display = 'none'; $box.innerHTML=''; }
  function showBox(){ $box.style.display = 'block'; }

  async function searchCustomers(q){
    const url = `/api/customers/search?q=${encodeURIComponent(q)}&limit=12`;
    const res = await fetch(url, {headers: {'Accept':'application/json'}});
    if(!res.ok) return [];
    return await res.json();
  }

  function render(items){
    if(!items || !items.length){ hideBox(); return; }
    $box.innerHTML = items.map(c => {
      const sub = [
        c.phone ? `โทร: ${c.phone}` : '',
        c.tax_id ? `TAX: ${c.tax_id}` : ''
      ].filter(Boolean).join(' • ');
      return `<button type="button" data-id="${c.id}">
        <strong>${escapeHtml(c.name)}</strong>
        ${sub ? `<span class="muted">${escapeHtml(sub)}</span>` : ''}
      </button>`;
    }).join('');
    showBox();
  }

  function escapeHtml(s){
    return (s||'').replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));
  }

  async function handleInput(){
    const q = ($search.value || '').trim();
    if(q.length < 1){ hideBox(); return; }
    const items = await searchCustomers(q);
    render(items);
  }

  $search?.addEventListener('input', () => {
    clearTimeout(t);
    t = setTimeout(handleInput, 200);
  });

  $box?.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button[data-id]');
    if(!btn) return;
    const id = btn.getAttribute('data-id');
    $cid.value = id;

    // เติมข้อมูลจาก API
    const res = await fetch(`/api/customers/${id}`, {headers:{'Accept':'application/json'}});
    if(res.ok){
      const c = await res.json();
      $search.value = c.name || '';
      if($name) $name.value = c.name || '';
      if($tax) $tax.value = c.tax_id || '';
      if($phone) $phone.value = c.phone || '';
      if($email) $email.value = c.email || '';
      if($addr) $addr.value = c.address || '';
    }
    hideBox();
  });

  document.addEventListener('click', (e)=>{
    if(e.target.closest('#customer_suggest')) return;
    if(e.target.closest('#customer_search')) return;
    hideBox();
  });

})();
</script>

{% endblock %}

{% block scripts %}
<script>
function addRow(){
  const tbody = document.querySelector("#itemsTable tbody");
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td><input class="input" name="item_description" value=""></td>
    <td><input class="input right" name="item_qty" value="1"></td>
    <td><input class="input right" name="item_unit_price" value="0"></td>
    <td><input class="input right" name="item_discount_amount" value="0"></td>
    <td class="center"><button class="row-btn" type="button" onclick="removeRow(this)">✖</button></td>
  `;
  tbody.appendChild(tr);
}
function removeRow(btn){
  const tr = btn.closest("tr");
  if(tr) tr.remove();
}
</script>

<style>
  .suggest{
    position:absolute;
    left:0; right:0;
    top: calc(100% + 6px);
    background: rgba(20, 26, 38, .98);
    border: 1px solid rgba(255,255,255,.10);
    border-radius: 14px;
    box-shadow: 0 18px 50px rgba(0,0,0,.25);
    overflow: hidden;
    z-index: 50;
  }
  .suggest button{
    display:block;
    width:100%;
    text-align:left;
    padding:10px 12px;
    background: transparent;
    border:0;
    color: #e6eefc;
    cursor:pointer;
  }
  .suggest button:hover{
    background: rgba(255,255,255,.06);
  }
  .suggest .muted{
    display:block;
    font-size:12px;
    opacity:.75;
    margin-top:2px;
  }
</style>

<script>
(function(){
  const $search = document.getElementById('customer_search');
  const $box = document.getElementById('customer_suggest');
  const $cid = document.getElementById('customer_id');

  const $name = document.getElementById('customer_name');
  const $tax = document.querySelector('[name="customer_tax_id"]');
  const $phone = document.querySelector('[name="customer_phone"]');
  const $email = document.querySelector('[name="customer_email"]');
  const $addr = document.querySelector('[name="customer_address"]');

  let t = null;

  function hideBox(){ $box.style.display = 'none'; $box.innerHTML=''; }
  function showBox(){ $box.style.display = 'block'; }

  async function searchCustomers(q){
    const url = `/api/customers/search?q=${encodeURIComponent(q)}&limit=12`;
    const res = await fetch(url, {headers: {'Accept':'application/json'}});
    if(!res.ok) return [];
    return await res.json();
  }

  function render(items){
    if(!items || !items.length){ hideBox(); return; }
    $box.innerHTML = items.map(c => {
      const sub = [
        c.phone ? `โทร: ${c.phone}` : '',
        c.tax_id ? `TAX: ${c.tax_id}` : ''
      ].filter(Boolean).join(' • ');
      return `<button type="button" data-id="${c.id}">
        <strong>${escapeHtml(c.name)}</strong>
        ${sub ? `<span class="muted">${escapeHtml(sub)}</span>` : ''}
      </button>`;
    }).join('');
    showBox();
  }

  function escapeHtml(s){
    return (s||'').replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));
  }

  async function handleInput(){
    const q = ($search.value || '').trim();
    if(q.length < 1){ hideBox(); return; }
    const items = await searchCustomers(q);
    render(items);
  }

  $search?.addEventListener('input', () => {
    clearTimeout(t);
    t = setTimeout(handleInput, 200);
  });

  $box?.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button[data-id]');
    if(!btn) return;
    const id = btn.getAttribute('data-id');
    $cid.value = id;

    // เติมข้อมูลจาก API
    const res = await fetch(`/api/customers/${id}`, {headers:{'Accept':'application/json'}});
    if(res.ok){
      const c = await res.json();
      $search.value = c.name || '';
      if($name) $name.value = c.name || '';
      if($tax) $tax.value = c.tax_id || '';
      if($phone) $phone.value = c.phone || '';
      if($email) $email.value = c.email || '';
      if($addr) $addr.value = c.address || '';
    }
    hideBox();
  });

  document.addEventListener('click', (e)=>{
    if(e.target.closest('#customer_suggest')) return;
    if(e.target.closest('#customer_search')) return;
    hideBox();
  });

})();
</script>

{% endblock %}
