{% extends "base.html" %}
{% set title = "‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£" %}

{% block content %}

{# =========================================================
   ‚úÖ PRINT RULES (‡πÑ‡∏°‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏ß + ‡∏Ñ‡∏∏‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©)
   - ‡∏ã‡πà‡∏≠‡∏ô UI ‡∏ï‡∏≠‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå ‡∏î‡πâ‡∏ß‡∏¢ visibility
   - PV / PV_WHT: A4 ‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á (2 ‡πÉ‡∏ö‡∏ï‡πà‡∏≠ 1 ‡πÅ‡∏ú‡πà‡∏ô ‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ö‡∏ô/‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏•‡πà‡∏≤‡∏á)
   - ‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏ó‡∏ô‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô (RR): A4 ‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á (1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠ 1 ‡πÅ‡∏ú‡πà‡∏ô / ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏≠‡∏¢‡∏π‡πà ‚Äú‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ö‡∏ô‚Äù)
   ========================================================= #}

{% set _dt = (doc_type or "PV")|upper %}

{% if _dt in ["PV","PV_WHT"] %}
<style>
  @media print {
    @page { size: A4 portrait; margin: 0mm; }

    body * { visibility: hidden !important; }
    .print-area, .print-area * { visibility: visible !important; }

    .print-area{
      position: absolute !important;
      left: 0 !important;
      top: 0 !important;
      width: 100% !important;
      margin: 0 !important;
      padding: 0 !important;
    }

    img { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  }

  /* Preview */
  .print-area { margin-top: 12px; display: grid; gap: 12px; }
  .doc-page { background:#fff; }

  /* =========================================================
     PV / PV_WHT: 1 ‡πÅ‡∏ú‡πà‡∏ô A4 = 2 ‡πÉ‡∏ö (‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ö‡∏ô + ‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏•‡πà‡∏≤‡∏á)
     ========================================================= */
  .a4page{
    width: 210mm;
    height: 297mm;
    box-sizing: border-box;
    padding: 10mm;
    background: #fff;

    page-break-after: always;
    break-after: page;

    display: grid;
    grid-template-rows: 1fr 1fr;
    gap: 6mm;
  }
  .a4page:last-child{
    page-break-after: auto;
    break-after: auto;
  }

  .half{
    box-sizing: border-box;
    height: 100%;
    overflow: hidden;
    break-inside: avoid;
    page-break-inside: avoid;
  }

  /* ‡∏Å‡∏±‡∏ô‡πÉ‡∏ö PV ‡πÅ‡∏ï‡∏Å‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤ */
  .pv-form{
    break-inside: avoid;
    page-break-inside: avoid;
  }
</style>
{% else %}
<style>
  @media print {
    @page { size: A4 portrait; margin: 0mm; }

    body * { visibility: hidden !important; }
    .print-area, .print-area * { visibility: visible !important; }

    .print-area{
      position: absolute !important;
      left: 0 !important;
      top: 0 !important;
      width: 100% !important;
      margin: 0 !important;
      padding: 0 !important;
    }

    img { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  }

  /* Preview */
  .print-area { margin-top: 12px; display: grid; gap: 12px; }
  .doc-page { background:#fff; }

  /* =========================================================
     ‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏ó‡∏ô‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô (RR)
     ‚úÖ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠ 1 ‡πÅ‡∏ú‡πà‡∏ô A4
     ‚úÖ ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏≠‡∏¢‡∏π‡πà ‚Äú‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ö‡∏ô‚Äù ‡∏Ç‡∏≠‡∏á A4 (‡∏Ñ‡∏£‡∏∂‡πà‡∏á A4 ‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á)
     ========================================================= */

  .a4sheet{
    width: 210mm;
    height: 297mm;
    box-sizing: border-box;
    padding: 10mm;
    background: #fff;

    page-break-after: always;
    break-after: page;
  }
  .a4sheet:last-child{
    page-break-after: auto;
    break-after: auto;
  }

  /* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ñ‡∏£‡∏∂‡πà‡∏á A4 (‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á) */
  .halfA4{
    width: 100%;
    height: 148.5mm; /* ‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏Ç‡∏≠‡∏á 297mm */
    box-sizing: border-box;
    overflow: hidden;
    break-inside: avoid;
    page-break-inside: avoid;
  }

  /* ‡∏Å‡∏±‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏ï‡∏Å‡∏´‡∏ô‡πâ‡∏≤ */
  .halfA4 *{
    break-inside: avoid;
    page-break-inside: avoid;
  }

  /* ‚úÖ ‡∏•‡∏ö‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô ‚Äú‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô (‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô)‚Äù ‡∏≠‡∏≠‡∏Å ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏ã‡πá‡∏ô‡∏°‡∏∑‡∏≠‡πÄ‡∏≠‡∏á */
  .sig-emp img,
  .sig-employee img,
  .sigEmp img,
  .sigEmployee img{
    display: none !important;
  }
</style>
{% endif %}

{# =========================================================
   ‚úÖ Helpers (format + pick date)
   - ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö row.kind ‡πÉ‡∏´‡∏°‡πà "A" (‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏ö‡∏¥‡∏Å‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤)
   - ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠ meta ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡πâ template ‡∏¢‡πà‡∏≠‡∏¢ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏™‡πà‡∏ß‡∏ô‡πÑ‡∏´‡∏ô‡πÉ‡∏ä‡πâ)
   ========================================================= #}
{% macro _fmt_date(d) -%}
  {%- if d is none -%}
    {{ "" }}
  {%- else -%}
    {# d ‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô date ‡∏´‡∏£‡∏∑‡∏≠ string #}
    {%- if d.__class__.__name__ in ["date","datetime"] -%}
      {{ d.strftime("%Y-%m-%d") }}
    {%- else -%}
      {{ d|string }}
    {%- endif -%}
  {%- endif -%}
{%- endmacro %}

<div class="card no-print" style="display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;">
  <div>
    <div class="section-title">
      ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£:
      {% if _dt == "PV" %}
        ‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏à‡πà‡∏≤‡∏¢
      {% elif _dt == "PV_WHT" %}
        ‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏à‡πà‡∏≤‡∏¢ (‡∏´‡∏±‡∏Å ‡∏ì ‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢)
      {% else %}
        ‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏ó‡∏ô‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô
      {% endif %}
    </div>
    <div class="muted">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£: {{ project.code }} ‚Äî {{ project.name }}</div>
    {% if rows %}
      <div class="muted">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: <b>{{ rows|length }}</b></div>

      {# ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå (‡∏ä‡πà‡∏ß‡∏¢ debug ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏ä‡∏ô‡∏¥‡∏î) #}
      {% set ns = namespace(m=0, s=0, e=0, a=0) %}
      {% for r in rows %}
        {% if (r.kind or '') == 'M' %}{% set ns.m = ns.m + 1 %}{% endif %}
        {% if (r.kind or '') in ['S','S_WHT'] %}{% set ns.s = ns.s + 1 %}{% endif %}
        {% if (r.kind or '') == 'E' %}{% set ns.e = ns.e + 1 %}{% endif %}
        {% if (r.kind or '') == 'A' %}{% set ns.a = ns.a + 1 %}{% endif %}
      {% endfor %}
      <div class="muted" style="font-size:12px; opacity:.8;">
        ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ‡∏ß‡∏±‡∏™‡∏î‡∏∏ {{ ns.m }} ¬∑ ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤ {{ ns.s }} ¬∑ ‡∏≠‡∏∑‡πà‡∏ô‡πÜ {{ ns.e }} ¬∑ ‡πÄ‡∏ö‡∏¥‡∏Å‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ {{ ns.a }}
      </div>
    {% endif %}
  </div>
  <div style="display:flex; gap:8px; flex-wrap:wrap;">
    <button class="btn btn-primary" type="button" onclick="window.print()">üñ®Ô∏è Print</button>
    <a class="btn" href="{{ url_for('pages.project_view', pid=project.id) }}">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</a>
  </div>
</div>

{% if not rows %}
  <div class="card mt-12">
    <div class="muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå</div>
  </div>
{% endif %}

<div class="print-area">
{% if rows %}

  {# =========================================================
     ‚úÖ PV / PV_WHT: 2 ‡πÉ‡∏ö‡∏ï‡πà‡∏≠ 1 ‡πÅ‡∏ú‡πà‡∏ô A4 (‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ö‡∏ô/‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏•‡πà‡∏≤‡∏á)
     ========================================================= #}
  {% if _dt in ["PV","PV_WHT"] %}

    {% for r in rows %}
      {% if loop.index0 % 2 == 0 %}
        <div class="a4page">
      {% endif %}

      <div class="half">
        {# ‡∏™‡πà‡∏á ‚Äú‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‚Äù ‡πÄ‡∏Ç‡πâ‡∏≤ PV #}
        {% set _rows_one = [r] %}
        {% set rows = _rows_one %}

        {# ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå print_pv.html ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô #}
        {% set doc_type = _dt %}

        {# ‚úÖ doc_date: ‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ (S: pay_date, E: expense_date, A: advance_date, M: materials_tax_invoice_date)
           - ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ ‡∏Ñ‡πà‡∏≠‡∏¢ fallback ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
        #}
        {% set _row_date = (r.date if r.date is defined else None) %}
        {% if not _row_date %}
          {% if (r.kind or '') == 'M' and r.tax_invoice_date is defined %}
            {% set _row_date = r.tax_invoice_date %}
          {% endif %}
        {% endif %}
        {% set doc_date = _fmt_date(_row_date or today) %}

        {% set project_code = project.code %}
        {% set project_name = project.name %}

        {# ‚úÖ total_amount ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô "‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡πÉ‡∏ö‡∏ô‡∏±‡πâ‡∏ô"
           - PV: ‡πÉ‡∏ä‡πâ r.amount
           - PV_WHT: ‡πÉ‡∏ä‡πâ "‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á" (contract - withholding)
        #}
        {% if _dt == "PV_WHT" %}
          {% set contract_amount = (r.contract_amount if r.contract_amount is defined else (r.gross_amount if r.gross_amount is defined else (r.amount or 0))) %}
          {% set withholding_amount = (r.withholding_amount if r.withholding_amount is defined else 0) %}
          {% set total_amount = ((contract_amount|float) - (withholding_amount|float)) %}
        {% else %}
          {% set total_amount = (r.amount or 0) %}
        {% endif %}

        {# ‚úÖ ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠ meta ‡∏ö‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡πâ template ‡∏¢‡πà‡∏≠‡∏¢ (‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ç‡∏≤‡πÉ‡∏ä‡πâ)
           - kind: M/S/E/A
           - tax_invoice_no: ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏™‡∏î‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        #}
        {% set row_kind = (r.kind or "") %}
        {% set tax_invoice_no = (r.tax_invoice_no if r.tax_invoice_no is defined else "") %}

        {% include "projects/vouchers/print_pv.html" %}
      </div>

      {% if loop.index0 % 2 == 1 or loop.last %}
        </div>
      {% endif %}
    {% endfor %}

  {% else %}

  {# =========================================================
     ‚úÖ RR: ‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏ó‡∏ô‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô
     - 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ = 1 ‡πÅ‡∏ú‡πà‡∏ô A4
     - ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ö‡∏ô (‡∏Ñ‡∏£‡∏∂‡πà‡∏á A4 ‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á)
     ========================================================= #}

    {% for r in rows %}
      <div class="a4sheet">
        <div class="halfA4">

          {% set _rows_one = [r] %}
          {% set rows = _rows_one %}

          {# ‚úÖ total_amount ‡∏ï‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡∏™‡∏∞‡∏Å‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á #}
          {% set total_amount = (r.amount or 0) %}

          {% set doc_type = _dt %}

          {# ‚úÖ doc_date: ‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ -> fallback ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ #}
          {% set _row_date = (r.date if r.date is defined else None) %}
          {% if not _row_date %}
            {% if (r.kind or '') == 'M' and r.tax_invoice_date is defined %}
              {% set _row_date = r.tax_invoice_date %}
            {% endif %}
          {% endif %}
          {% set doc_date = _fmt_date(_row_date or today) %}

          {% set project_code = project.code %}
          {% set project_name = project.name %}

          {# meta ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÉ‡∏´‡πâ template ‡∏¢‡πà‡∏≠‡∏¢ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÉ‡∏ä‡πâ) #}
          {% set row_kind = (r.kind or "") %}
          {% set tax_invoice_no = (r.tax_invoice_no if r.tax_invoice_no is defined else "") %}

          {% include "projects/vouchers/print_receipt_cert.html" %}
        </div>
      </div>
    {% endfor %}

  {% endif %}
{% endif %}
</div>

{% endblock %}
