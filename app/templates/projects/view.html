{% extends 'base.html' %} 
{% set title = '‡∏î‡∏π‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£' %}

{% block content %}

<style>
  /* ===== Mobile-first ===== */
  .stickyTotals{
    position: sticky;
    top: 0;
    z-index: 30;
    backdrop-filter: blur(10px);
    background: rgba(17, 24, 39, .55);
    border: 1px solid rgba(255,255,255,.08);
    border-radius: 16px;
    padding: 12px;
  }
  .stickyTotals .grid{
    display:grid;
    grid-template-columns: repeat(2,minmax(0,1fr));
    gap: 10px;
  }
  .kpi{
    border: 1px solid rgba(255,255,255,.08);
    border-radius: 14px;
    padding: 10px 12px;
    background: rgba(255,255,255,.03);
  }
  .kpi .k{ font-size: 12px; opacity: .75; }
  .kpi .v{ font-size: 18px; font-weight: 800; margin-top: 2px; }
  .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

  /* ‚úÖ NEW: KPI wide (‡πÉ‡∏´‡πâ‡∏Å‡∏•‡πà‡∏≠‡∏á ‚Äú‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‚Äù ‡∏Å‡∏¥‡∏ô‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏ñ‡∏ß) */
  .kpi-wide{ grid-column: 1 / -1; }

  /* ===== Voucher Toolbar (‡∏à‡∏±‡∏î‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡πÉ‡∏´‡∏°‡πà) ===== */
  .voucherBar{
    margin-top: 14px;
    border: 1px solid rgba(255,255,255,.08);
    background: rgba(255,255,255,.03);
    border-radius: 16px;
    padding: 12px;
  }
  .voucherToolbar{
    display: grid;
    grid-template-columns: 1.2fr auto auto;
    gap: 12px;
    align-items: center;
  }
  .voucherLeft{
    min-width: 260px;
  }
  .voucherLeft label{
    display:block;
    font-size:12px;
    opacity:.85;
    margin-bottom:6px;
  }
  .voucherLeft select.input{
    width: 100%;
  }
  .voucherHelp{
    margin-top:6px;
    font-size:12px;
    opacity:.75;
    line-height: 1.35;
  }

  .countChip{
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 12px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.04);
    white-space: nowrap;
  }
  .countChip .k{ font-size:12px; opacity:.75; }
  .countChip .v{
    font-size: 18px;
    font-weight: 900;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  }

  .voucherActions{
    display:flex;
    gap: 8px;
    flex-wrap: wrap;
    justify-content: flex-end;
  }

  /* responsive */
  @media (max-width: 980px){
    .voucherToolbar{
      grid-template-columns: 1fr;
      align-items: stretch;
    }
    .voucherActions{
      justify-content: flex-start;
    }
    .countChip{
      width: fit-content;
    }
  }

  .mutedSmall{
    font-size: 12px;
    opacity: .75;
  }
  .miniCard{
    border: 1px solid rgba(255,255,255,.08);
    border-radius: 14px;
    background: rgba(255,255,255,.03);
  }
  .miniCard .k{ font-size: 12px; opacity: .7; }
  .miniCard .v{ font-size: 22px; font-weight: 900; margin-top: 2px; }

  .table-wrap{ overflow:auto; border-radius: 14px; border:1px solid rgba(255,255,255,.08); }
  table.table{ width:100%; border-collapse: collapse; }
  table.table th, table.table td{
    padding: 10px 12px;
    border-bottom: 1px solid rgba(255,255,255,.06);
    white-space: nowrap;
  }
  table.table thead th{
    font-size: 12px;
    opacity: .8;
    background: rgba(255,255,255,.03);
  }
  .right{ text-align:right; }
  .col-check{ width: 74px; }
  .only-mobile{ display:block; }
  .only-desktop{ display:none; }
  @media (min-width: 900px){
    .only-mobile{ display:none; }
    .only-desktop{ display:block; }
  }

  /* ===== ‚úÖ BOQ Card (NEW) ===== */
  .boqCard{
    margin-top: 14px;
    border: 1px solid rgba(255,255,255,.08);
    background: rgba(255,255,255,.03);
    border-radius: 16px;
    padding: 12px;
  }
  .boqToolbar{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap: 12px;
    flex-wrap: wrap;
  }
  .boqActions{
    display:flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  .boqMeta{
    font-size: 12px;
    opacity: .78;
    margin-top: 6px;
    line-height: 1.35;
  }
</style>

<div class="card">
  <div style="display:flex; gap:10px; justify-content:space-between; flex-wrap:wrap; align-items:flex-start;">
    <div>
      <div class="section-title">{{ project.code }} ‚Äî {{ project.name }}</div>
      <div class="muted">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <b>{{ project.status or "‚Äî" }}</b></div>
      {% if project.customer_name %}<div class="muted">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: {{ project.customer_name }}</div>{% endif %}
      {% if project.location %}<div class="muted">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: {{ project.location }}</div>{% endif %}
    </div>

    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <a class="btn" href="{{ url_for('pages.project_list') }}">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</a>
      <a class="btn" href="{{ url_for('pages.project_edit', pid=project.id) }}">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</a>
      <a class="btn" href="{{ url_for('pages.project_export_xlsx', pid=project.id) }}">Export Excel</a>
    </div>
  </div>

  {# ==========================
     ‚úÖ NEW: BOQ Download Section
     - ‡πÉ‡∏ä‡πâ field ‡πÉ‡∏ô Project: boq_excel_path / boq_pdf_path
     - ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ qt_doc (‡∏™‡πà‡∏á‡∏à‡∏≤‡∏Å pages.project_view) ‡∏à‡∏∞‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î QT ‡πÄ‡∏û‡∏¥‡πà‡∏°
     ========================== #}

  {% set has_boq_excel = (project.boq_excel_path or '')|trim %}
  {% set has_boq_pdf = (project.boq_pdf_path or '')|trim %}

  {% if has_boq_excel or has_boq_pdf or (qt_doc is defined and qt_doc) %}
  <div class="boqCard">
    <div class="boqToolbar">
      <div>
        <div class="section-title" style="font-size:16px;">BOQ / ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö</div>
        <div class="boqMeta">
          ‡πÑ‡∏ü‡∏•‡πå BOQ ‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ (QT) ‚Äî ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
          {% if not has_boq_excel and not has_boq_pdf %}
            <br><span class="mutedSmall">* ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå BOQ ‡πÅ‡∏ô‡∏ö‡πÑ‡∏ß‡πâ</span>
          {% endif %}
        </div>
      </div>

      <div class="boqActions">
        {% if qt_doc is defined and qt_doc %}
          <a class="btn btn-ghost" href="{{ url_for('docs.doc_view', doc_id=qt_doc.id) }}">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ (QT)</a>
        {% endif %}

        {% if has_boq_excel %}
          <a class="btn" href="{{ url_for('pages.project_download_boq_excel', pid=project.id) }}">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î BOQ (Excel)</a>
        {% endif %}

        {% if has_boq_pdf %}
          <a class="btn" href="{{ url_for('pages.project_download_boq_pdf', pid=project.id) }}">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î BOQ (PDF)</a>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}

  <div class="mt-12 stickyTotals">
    <div class="grid">

      {# ==========================
         ‚úÖ NEW: ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á QT ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡∏Å‡∏Å‡∏±‡∏ö Project)
         - ‡πÉ‡∏ä‡πâ qt_doc (SalesDoc) ‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å pages.project_view
         - ‡∏Ñ‡∏¥‡∏î‡∏¢‡∏≠‡∏î‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ print QT: ‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ -> ‡∏´‡∏±‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î -> ‡∏´‡∏±‡∏Å WHT -> ‡∏ö‡∏ß‡∏Å VAT
         ========================== #}
      {% if qt_doc is defined and qt_doc %}
        {% set nsqt = namespace(subtotal=0) %}
        {% for it in (qt_doc.items or []) %}
          {% set qty = (it.qty or 0) %}
          {% set price = (it.unit_price or 0) %}
          {% set line_disc = (it.discount_amount or 0) %}
          {% set line_total = (qty * price) - line_disc %}
          {% set nsqt.subtotal = nsqt.subtotal + line_total %}
        {% endfor %}

        {% set qt_subtotal = nsqt.subtotal %}
        {% set qt_discount_total = (qt_doc.discount_amount or 0) %}
        {% set qt_net_before_tax = qt_subtotal - qt_discount_total %}
        {% set qt_vat_rate = (qt_doc.vat_rate or 0) %}
        {% set qt_wht_rate = (qt_doc.wht_rate or 0) %}
        {% set qt_wht_amount = (qt_net_before_tax * qt_wht_rate) / 100 %}
        {% set qt_net_after_wht = qt_net_before_tax - qt_wht_amount %}
        {% set qt_vat_amount = (qt_net_after_wht * qt_vat_rate) / 100 %}
        {% set qt_grand_total = qt_net_after_wht + qt_vat_amount %}

        <div class="kpi kpi-wide">
          <div class="k">‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</div>
          <div class="v" style="font-size:14px; font-weight:800; margin-top:2px;">
            {{ qt_doc.doc_no }}
            {% if qt_doc.customer_name or (qt_doc.customer and qt_doc.customer.name) %}
              ‚Ä¢ {{ qt_doc.customer_name or qt_doc.customer.name }}
            {% endif %}
          </div>
          <div class="k" style="margin-top:6px;">‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô (‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤)</div>
          <div class="v mono">{{ "%.2f"|format(qt_grand_total or 0) }}</div>
        </div>
      {% endif %}

      <div class="kpi">
        <div class="k">‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏™‡∏î‡∏∏</div>
        <div class="v mono">{{ "%.2f"|format(materials_total or 0) }}</div>
      </div>
      <div class="kpi">
        <div class="k">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡∏ä‡πà‡∏ß‡∏á</div>
        <div class="v mono">{{ "%.2f"|format(subs_total or 0) }}</div>
      </div>
      <div class="kpi">
        <div class="k">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô</div>
        <div class="v mono">{{ "%.2f"|format(expenses_total or 0) }}</div>
      </div>
      <div class="kpi">
        <div class="k">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
        <div class="v mono">{{ "%.2f"|format(grand_total or 0) }}</div>
      </div>
    </div>
  </div>

  {% if project.description %}
  <div class="mt-12">
    <div class="label">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</div>
    <div>{{ project.description }}</div>
  </div>
  {% endif %}
</div>

<!-- Voucher Print Bar (‡∏à‡∏±‡∏î‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡πÅ‡∏ö‡∏ö Toolbar) -->
<form id="voucherForm" class="voucherBar" method="POST" action="{{ url_for('pages.vouchers_print', pid=project.id) }}" target="_blank">

  <div class="voucherToolbar">
    <div class="voucherLeft">
      <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå</label>
      <select class="input" name="doc_type" id="doc_type">
        <option value="PV">‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏à‡πà‡∏≤‡∏¢ (PAYMENT VOUCHER)</option>
        <option value="RR">‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏ó‡∏ô‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</option>
        <!-- ‚úÖ FIX: ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ option ‡∏ô‡∏µ‡πâ (‡∏ã‡πà‡∏≠‡∏ô) ‡πÑ‡∏°‡πà‡∏á‡∏±‡πâ‡∏ô submitWHT() ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤ PV_WHT ‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î -->
        <option value="PV_WHT" style="display:none;">‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏à‡πà‡∏≤‡∏¢ (‡∏´‡∏±‡∏Å ‡∏ì ‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢)</option>
      </select>

      <div class="voucherHelp">
        ‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á (‡∏ß‡∏±‡∏™‡∏î‡∏∏/‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤/‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô) ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏û‡∏¥‡∏°‡∏û‡πå<br>
        <b>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</b> ‡∏õ‡∏∏‡πà‡∏° ‚Äú‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏à‡πà‡∏≤‡∏¢ (‡∏´‡∏±‡∏Å ‡∏ì ‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢)‚Äù ‡∏à‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‚Äú‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡∏ä‡πà‡∏ß‡∏á‚Äù ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      </div>
    </div>

    <div class="countChip">
      <span class="k">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</span>
      <span class="v" id="selectedCount">0</span>
    </div>

    <div class="voucherActions">
      <button class="btn" type="button" onclick="VoucherUI.selectAll()">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
      <button class="btn" type="button" onclick="VoucherUI.clearAll()">‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>

      <!-- ‚úÖ NEW: PV_WHT Button -->
      <button class="btn" type="button" onclick="return VoucherUI.submitWHT()">üßæ ‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏à‡πà‡∏≤‡∏¢ (‡∏´‡∏±‡∏Å ‡∏ì ‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢)</button>

      <button class="btn btn-primary" type="submit" onclick="return VoucherUI.beforeSubmit()">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
    </div>
  </div>

  <!-- hidden inputs will be injected here -->
  <div id="voucherHidden"></div>
</form>

<!-- Materials -->
<div class="card mt-12">
  <div class="section-head">
    <div>
      <div class="section-title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏™‡∏î‡∏∏</div>
      <div class="muted">‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏à‡πà‡∏≤‡∏¢/‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏ó‡∏ô‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</div>
    </div>
  </div>

  <!-- Desktop table -->
  <div class="only-desktop">
    <div class="table-wrap">
      <table class="table">
        <thead>
          <tr>
            <th class="col-check">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</th>
            <th>‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠</th>
            <th>‡∏£‡∏´‡∏±‡∏™</th>
            <th>‡∏ä‡∏∑‡πà‡∏≠</th>
            <th class="right">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
            <th class="right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
            <th class="right">‡∏£‡∏ß‡∏°</th>
          </tr>
        </thead>
        <tbody>
          {% for m in (project.materials or []) %}
          {% set amount = (m.unit_price or 0) * (m.qty or 0) %}
          <tr>
            <td class="center">
              <input class="vchk" type="checkbox" data-id="M:{{ m.id }}">
              <span class="mutedSmall">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</span>
            </td>
            <td>{{ m.brand or "" }}</td>
            <td class="mono">{{ m.item_code or "" }}</td>
            <td>{{ m.item_name or "" }}</td>
            <td class="right mono">{{ "%.2f"|format(m.unit_price or 0) }}</td>
            <td class="right mono">{{ "%.2f"|format(m.qty or 0) }}</td>
            <td class="right mono">{{ "%.2f"|format(amount) }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Mobile cards -->
  <div class="only-mobile">
    {% for m in (project.materials or []) %}
    {% set amount = (m.unit_price or 0) * (m.qty or 0) %}
    <div class="miniCard" style="padding:12px; margin-top:10px;">
      <div style="display:flex; gap:10px; align-items:flex-start; justify-content:space-between;">
        <div>
          <div><b>{{ m.item_name or "" }}</b></div>
          <div class="mutedSmall">‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠: {{ m.brand or "" }}</div>
          <div class="mutedSmall mono">‡∏£‡∏´‡∏±‡∏™: {{ m.item_code or "" }}</div>
        </div>
        <div>
          <input class="vchk" type="checkbox" data-id="M:{{ m.id }}">
          <span class="mutedSmall">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</span>
        </div>
      </div>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
        <div class="mutedSmall">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢<br><b class="mono">{{ "%.2f"|format(m.unit_price or 0) }}</b></div>
        <div class="mutedSmall">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô<br><b class="mono">{{ "%.2f"|format(m.qty or 0) }}</b></div>
        <div class="mutedSmall">‡∏£‡∏ß‡∏°<br><b class="mono">{{ "%.2f"|format(amount) }}</b></div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<!-- Subcontractors -->
<div class="card mt-12">
  <div class="section-head">
    <div>
      <div class="section-title">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡∏ä‡πà‡∏ß‡∏á</div>
      <div class="muted">‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏à‡πà‡∏≤‡∏¢/‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏ó‡∏ô‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</div>
    </div>
  </div>

  <div class="only-desktop">
    <div class="table-wrap">
      <table class="table">
        <thead>
          <tr>
            <th class="col-check">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</th>
            <th>‡∏ä‡∏∑‡πà‡∏≠</th>
            <th class="right">‡∏ß‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á</th>
            <th class="right">% ‡∏´‡∏±‡∏Å ‡∏ì ‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢</th>
            <th class="right">‡∏´‡∏±‡∏Å (‡∏ö‡∏≤‡∏ó)</th>
            <th class="right">‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á</th>
          </tr>
        </thead>
        <tbody>
          {% for s in (project.subcontractors or []) %}
          {% set net = (s.contract_amount or 0) - (s.withholding_amount or 0) %}
          <tr>
            <td class="center">
              <input class="vchk" type="checkbox" data-id="S:{{ s.id }}">
              <span class="mutedSmall">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</span>
            </td>
            <td><b>{{ s.vendor_name or "‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤" }}</b></td>
            <td class="right mono">{{ "%.2f"|format(s.contract_amount or 0) }}</td>
            <td class="right mono">{{ "%.2f"|format(s.withholding_rate or 0) }}</td>
            <td class="right mono">{{ "%.2f"|format(s.withholding_amount or 0) }}</td>
            <td class="right mono">{{ "%.2f"|format(net) }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="only-mobile">
    {% for s in (project.subcontractors or []) %}
    {% set net = (s.contract_amount or 0) - (s.withholding_amount or 0) %}
    <div class="miniCard" style="padding:12px; margin-top:10px;">
      <div style="display:flex; gap:10px; align-items:flex-start; justify-content:space-between;">
        <div>
          <div><b>{{ s.vendor_name or "‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤" }}</b></div>
        </div>
        <div>
          <input class="vchk" type="checkbox" data-id="S:{{ s.id }}">
          <span class="mutedSmall">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</span>
        </div>
      </div>

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
        <div class="mutedSmall">‡∏ß‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á<br><b class="mono">{{ "%.2f"|format(s.contract_amount or 0) }}</b></div>
        <div class="mutedSmall">% ‡∏´‡∏±‡∏Å ‡∏ì ‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢<br><b class="mono">{{ "%.2f"|format(s.withholding_rate or 0) }}</b></div>
        <div class="mutedSmall">‡∏´‡∏±‡∏Å (‡∏ö‡∏≤‡∏ó)<br><b class="mono">{{ "%.2f"|format(s.withholding_amount or 0) }}</b></div>
        <div class="mutedSmall">‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á<br><b class="mono">{{ "%.2f"|format(net) }}</b></div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<!-- Expenses -->
<div class="card mt-12">
  <div class="section-head">
    <div>
      <div class="section-title">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô</div>
      <div class="muted">‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏à‡πà‡∏≤‡∏¢/‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏ó‡∏ô‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</div>
    </div>
  </div>

  <div class="only-desktop">
    <div class="table-wrap">
      <table class="table">
        <thead>
          <tr>
            <th class="col-check">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</th>
            <th>‡∏´‡∏°‡∏ß‡∏î</th>
            <th>‡∏ä‡∏∑‡πà‡∏≠</th>
            <th class="right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
          </tr>
        </thead>
        <tbody>
          {% for e in (project.expenses or []) %}
          <tr>
            <td class="center">
              <input class="vchk" type="checkbox" data-id="E:{{ e.id }}">
              <span class="mutedSmall">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</span>
            </td>
            <td>{{ e.category or "‡∏≠‡∏∑‡πà‡∏ô‡πÜ" }}</td>
            <td>{{ e.title or "" }}</td>
            <td class="right mono">{{ "%.2f"|format(e.amount or 0) }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="only-mobile">
    {% for e in (project.expenses or []) %}
    <div class="miniCard" style="padding:12px; margin-top:10px;">
      <div style="display:flex; gap:10px; align-items:flex-start; justify-content:space-between;">
        <div>
          <div><b>{{ e.title or "" }}</b></div>
          <div class="mutedSmall">‡∏´‡∏°‡∏ß‡∏î: {{ e.category or "‡∏≠‡∏∑‡πà‡∏ô‡πÜ" }}</div>
        </div>
        <div>
          <input class="vchk" type="checkbox" data-id="E:{{ e.id }}">
          <span class="mutedSmall">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</span>
        </div>
      </div>
      <div class="mutedSmall" style="margin-top:10px;">
        ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô<br><b class="mono">{{ "%.2f"|format(e.amount or 0) }}</b>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<div class="mt-12"></div>

<script>
  const VoucherUI = {
    syncHidden(filterPrefix=null){
      const box = document.getElementById('voucherHidden');
      box.innerHTML = '';

      let checked = Array.from(document.querySelectorAll('.vchk:checked'));
      if(filterPrefix){
        checked = checked.filter(x => (x.getAttribute('data-id') || '').startsWith(filterPrefix));
      }

      for(const c of checked){
        const id = c.getAttribute('data-id');
        const inp = document.createElement('input');
        inp.type = 'hidden';
        inp.name = 'ids';
        inp.value = id;
        box.appendChild(inp);
      }

      // ‡∏ô‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡πä‡∏Å‡∏à‡∏£‡∏¥‡∏á (‡πÑ‡∏°‡πà filter) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á count ‡πÄ‡∏î‡∏¥‡∏°
      const allChecked = Array.from(document.querySelectorAll('.vchk:checked')).length;
      document.getElementById('selectedCount').textContent = String(allChecked);
    },

    selectAll(){
      document.querySelectorAll('.vchk').forEach(c => c.checked = true);
      this.syncHidden();
    },

    clearAll(){
      document.querySelectorAll('.vchk').forEach(c => c.checked = false);
      this.syncHidden();
    },

    beforeSubmit(){
      this.syncHidden();
      const n = document.querySelectorAll('.vchk:checked').length;
      if(n <= 0){
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå');
        return false;
      }
      return true;
    },

    // ‚úÖ NEW: Submit PV_WHT (‡∏™‡πà‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ S:...)
    submitWHT(){
      // ‡∏™‡πà‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ S:... ‡πÄ‡∏Ç‡πâ‡∏≤ hidden
      this.syncHidden('S:');

      const subChecked = Array.from(document.querySelectorAll('.vchk:checked'))
        .filter(x => (x.getAttribute('data-id') || '').startsWith('S:'));

      if(subChecked.length <= 0){
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡∏ä‡πà‡∏ß‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏à‡πà‡∏≤‡∏¢ (‡∏´‡∏±‡∏Å ‡∏ì ‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢)');
        return false;
      }

      const sel = document.getElementById('doc_type');
      const prev = sel.value;

      // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô doc_type ‡πÄ‡∏õ‡πá‡∏ô PV_WHT ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ‡πÅ‡∏•‡πâ‡∏ß submit
      sel.value = 'PV_WHT';
      document.getElementById('voucherForm').submit();
      sel.value = prev;

      return false;
    }
  };

  // keep desktop/mobile checkboxes in sync by data-id
  function bindSync(){
    const all = Array.from(document.querySelectorAll('.vchk'));
    all.forEach((el) => {
      el.addEventListener('change', () => {
        const id = el.getAttribute('data-id');
        const state = el.checked;
        document.querySelectorAll(`.vchk[data-id="${id}"]`).forEach(x => { x.checked = state; });
        VoucherUI.syncHidden();
      });
    });
    VoucherUI.syncHidden();
  }

  document.addEventListener('DOMContentLoaded', bindSync);
</script>

{% endblock %}
