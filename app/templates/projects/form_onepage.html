{% extends 'base.html' %}
{% set title = '‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£' %}

{% block content %}

<style>
  /* ===== Mobile-first tweaks (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ) ===== */
  .pagehead{
    position: sticky;
    top: 0;
    z-index: 20;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    padding-top: 10px;
    margin-top: -10px;
  }
  .pagehead .actions{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    justify-content:flex-end;
  }
  .btn{ min-height:44px; }
  .input{ min-height:44px; }
  .btn.btn-small{ min-height:40px; padding:8px 12px; }
  .table-wrap{
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
    border-radius: 14px;
  }
  .table{ min-width: 1120px; } /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏° 2 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå */
  .section-head{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    flex-wrap:wrap;
  }
  .section-head .section-title{ font-size: 18px; }
  .totals .totals__row{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
  }
  @media (max-width: 860px){
    .grid.grid-2{ grid-template-columns: 1fr !important; }
    .grid.grid-3{ grid-template-columns: 1fr !important; }
    .right{ text-align:left !important; }
    .table{ min-width: 980px; }
    .pagehead h1{ font-size: 22px; }
  }
</style>

<div class="pagehead">
  <div>
    <h1>{{ '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£' if project else '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£' }}</h1>
    <div class="muted">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>
  </div>
  <div class="actions">
    <a class="btn" href="{{ url_for('pages.project_list') }}">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</a>
    {% if project %}
      <a class="btn" href="{{ url_for('pages.project_view', pid=project.id) }}">üëÅÔ∏è ‡∏î‡∏π</a>
    {% endif %}
  </div>
</div>

<div class="card">
  <div class="grid grid-2">
    <div>
      <label class="label">‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ *</label>
      <input class="input" id="code" placeholder="‡πÄ‡∏ä‡πà‡∏ô PJ-2026-001" value="{{ project.code if project else '' }}">
      <div class="hint">‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥ (‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤)</div>
    </div>
    <div>
      <label class="label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
      <select class="input" id="status">
        <option value="IN_PROGRESS" {{ 'selected' if project and project.status=='IN_PROGRESS' else '' }}>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</option>
        <option value="DEFECT" {{ 'selected' if project and project.status=='DEFECT' else '' }}>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Å‡πá‡∏ö Defect</option>
        <option value="DONE" {{ 'selected' if project and project.status=='DONE' else '' }}>‡∏á‡∏≤‡∏ô‡∏à‡∏ö</option>
      </select>
    </div>
  </div>

  <div class="mt-12">
    <label class="label">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ *</label>
    <input class="input" id="name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏á‡∏≤‡∏ô‡∏ö‡∏¥‡πâ‡∏ß‡∏≠‡∏¥‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∏‡∏ì A" value="{{ project.name if project else '' }}">
  </div>

  <div class="grid grid-2 mt-12">
    <div>
      <label class="label">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
      <input class="input" id="customer_name" value="{{ project.customer_name if project else '' }}" placeholder="(‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)">
    </div>
    <div>
      <label class="label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</label>
      <input class="input" id="location" value="{{ project.location if project else '' }}" placeholder="(‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)">
    </div>
  </div>

  <div class="grid grid-3 mt-12">
    <div>
      <label class="label">‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°</label>
      <input class="input" id="start_date" type="date" value="{{ project.start_date if project and project.start_date else '' }}">
    </div>
    <div>
      <label class="label">‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
      <input class="input" id="end_date" type="date" value="{{ project.end_date if project and project.end_date else '' }}">
    </div>
    <div>
      <label class="label">‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡∏ß‡∏±‡∏ô)</label>
      <input class="input" id="work_days" type="number" min="0" step="1" value="{{ project.work_days if project else 0 }}">
    </div>
  </div>

  <div class="mt-12">
    <label class="label">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</label>
    <textarea class="input" id="description" rows="3" placeholder="‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡πà‡∏≤‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á...">{{ project.description if project and project.description else '' }}</textarea>
  </div>
</div>

<div class="mt-12">

  <!-- ‡∏ß‡∏±‡∏™‡∏î‡∏∏ -->
  <div class="card">
    <div class="section-head">
      <div>
        <div class="section-title">‡∏ß‡∏±‡∏™‡∏î‡∏∏ / ‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</div>
        <div class="muted">‡πÉ‡∏™‡πà‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠ / ‡∏£‡∏´‡∏±‡∏™ / ‡∏£‡∏≤‡∏Ñ‡∏≤ / ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô / ‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡πÑ‡∏î‡πâ)</div>
      </div>
      <button class="btn btn-small" type="button" onclick="Materials.addRow()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß</button>
    </div>

    <div class="table-wrap">
      <table class="table" id="materials_table">
        <thead>
          <tr>
            <th>‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠</th>
            <th>‡∏£‡∏´‡∏±‡∏™</th>
            <th>‡∏ä‡∏∑‡πà‡∏≠</th>
            <th>‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>
            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö</th>
            <th class="right">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
            <th class="right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
            <th class="right">‡∏£‡∏ß‡∏°</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="totals">
      <div class="totals__row">
        <div>‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏™‡∏î‡∏∏</div>
        <div class="mono" id="materials_total">0.00</div>
      </div>
    </div>
  </div>

  <!-- ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡∏ä‡πà‡∏ß‡∏á -->
  <div class="card mt-12">
    <div class="section-head">
      <div>
        <div class="section-title">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡∏ä‡πà‡∏ß‡∏á</div>
        <div class="muted">‡∏ß‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á / ‡∏´‡∏±‡∏Å ‡∏ì ‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢ (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á)</div>
      </div>
      <button class="btn btn-small" type="button" onclick="Subs.addRow()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß</button>
    </div>

    <div class="table-wrap">
      <table class="table" id="subs_table">
        <thead>
          <tr>
            <th>‡∏ä‡∏∑‡πà‡∏≠</th>
            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
            <th class="right">‡∏ß‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á</th>
            <th class="right">% ‡∏´‡∏±‡∏Å ‡∏ì ‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢</th>
            <th class="right">‡∏´‡∏±‡∏Å (‡∏ö‡∏≤‡∏ó)</th>
            <th class="right">‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="totals">
      <div class="totals__row">
        <div>‡∏£‡∏ß‡∏°‡∏à‡πà‡∏≤‡∏¢‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡∏ä‡πà‡∏ß‡∏á</div>
        <div class="mono" id="subs_total">0.00</div>
      </div>
    </div>
  </div>

  <!-- ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô -->
  <div class="card mt-12">
    <div class="section-head">
      <div>
        <div class="section-title">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô</div>
        <div class="muted">‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô, ‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô, ‡∏Ç‡∏ô‡∏™‡πà‡∏á ‡∏Ø‡∏•‡∏Ø (‡πÅ‡∏¢‡∏Å‡∏´‡∏°‡∏ß‡∏î‡πÑ‡∏î‡πâ)</div>
      </div>
      <button class="btn btn-small" type="button" onclick="Expenses.addRow()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß</button>
    </div>

    <div class="table-wrap">
      <table class="table" id="expenses_table">
        <thead>
          <tr>
            <th>‡∏´‡∏°‡∏ß‡∏î</th>
            <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
            <th class="right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="totals">
      <div class="totals__row">
        <div>‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô</div>
        <div class="mono" id="expenses_total">0.00</div>
      </div>
    </div>
  </div>

  <!-- ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏ö‡∏¥‡∏Å‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ -->
  <div class="card mt-12">
    <div class="section-head">
      <div>
        <div class="section-title">‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏ö‡∏¥‡∏Å‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤</div>
        <div class="muted">‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ñ‡πà‡∏≤‡∏≠‡∏∞‡πÑ‡∏£ / ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà / ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡πÑ‡∏î‡πâ)</div>
      </div>
      <button class="btn btn-small" type="button" onclick="Advances.addRow()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß</button>
    </div>

    <div class="table-wrap">
      <table class="table" id="advances_table">
        <thead>
          <tr>
            <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
            <th class="right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="totals">
      <div class="totals__row">
        <div>‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏ö‡∏¥‡∏Å‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤</div>
        <div class="mono" id="advances_total">0.00</div>
      </div>
    </div>
  </div>

</div>

<div class="card mt-12">
  <div class="grid grid-3">
    <div>
      <div class="label">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏™‡∏î‡∏∏ + ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡∏ä‡πà‡∏ß‡∏á + ‡∏≠‡∏∑‡πà‡∏ô‡πÜ + ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏ö‡∏¥‡∏Å‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤)</div>
      <div class="mono big" id="grand_total">0.00</div>
    </div>
    <div class="muted">
      <div class="label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</div>
      <div>‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏ï‡∏•‡∏≠‡∏î ‡πÅ‡∏•‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏£‡∏´‡∏±‡∏™/‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</div>
    </div>
    <div class="right">
      <button class="btn btn-primary" type="button" onclick="ProjectForm.save()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      {% if project %}
        <button class="btn btn-danger" type="button" onclick="ProjectForm.remove({{ project.id }})">üóëÔ∏è ‡∏•‡∏ö</button>
      {% endif %}
      <div class="hint" id="save_hint"></div>
    </div>
  </div>
</div>

<script id="project-data" type="application/json">
{% if project %}
{
  "id": {{ project.id|tojson }},
  "code": {{ (project.code or "")|tojson }},
  "name": {{ (project.name or "")|tojson }},
  "description": {{ (project.description or "")|tojson }},
  "customer_name": {{ (project.customer_name or "")|tojson }},
  "location": {{ (project.location or "")|tojson }},
  "start_date": {{ (project.start_date.isoformat() if project.start_date else "")|tojson }},
  "end_date": {{ (project.end_date.isoformat() if project.end_date else "")|tojson }},
  "work_days": {{ (project.work_days or 0)|tojson }},
  "status": {{ (project.status or "IN_PROGRESS")|tojson }},

  "materials": [
    {% if project.materials %}
      {% for m in project.materials %}
      {
        "brand": {{ (m.brand or "")|tojson }},
        "item_code": {{ (m.item_code or "")|tojson }},
        "item_name": {{ (m.item_name or "")|tojson }},
        "unit": {{ (m.unit or "")|tojson }},
        "tax_invoice_no": {{ (m.tax_invoice_no or "")|tojson }},
        "tax_invoice_date": {{ (m.tax_invoice_date.isoformat() if m.tax_invoice_date else "")|tojson }},
        "unit_price": {{ ((m.unit_price or 0)|float)|tojson }},
        "qty": {{ ((m.qty or 0)|float)|tojson }},
        "note": {{ (m.note or "")|tojson }}
      }{{ "," if not loop.last else "" }}
      {% endfor %}
    {% endif %}
  ],
  "subcontractors": [
    {% if project.subcontractors %}
      {% for s in project.subcontractors %}
      {
        "vendor_name": {{ (s.vendor_name or "")|tojson }},
        "pay_date": {{ (s.pay_date.isoformat() if s.pay_date else "")|tojson }},
        "contract_amount": {{ ((s.contract_amount or 0)|float)|tojson }},
        "withholding_rate": {{ ((s.withholding_rate or 0)|float)|tojson }},
        "withholding_amount": {{ ((s.withholding_amount or 0)|float)|tojson }},
        "note": {{ (s.note or "")|tojson }}
      }{{ "," if not loop.last else "" }}
      {% endfor %}
    {% endif %}
  ],
  "expenses": [
    {% if project.expenses %}
      {% for e in project.expenses %}
      {
        "category": {{ (e.category or "")|tojson }},
        "title": {{ (e.title or "")|tojson }},
        "expense_date": {{ (e.expense_date.isoformat() if e.expense_date else "")|tojson }},
        "amount": {{ ((e.amount or 0)|float)|tojson }},
        "note": {{ (e.note or "")|tojson }}
      }{{ "," if not loop.last else "" }}
      {% endfor %}
    {% endif %}
  ],
  "advances": [
    {% if project.advances %}
      {% for a in project.advances %}
      {
        "title": {{ (a.title or "")|tojson }},
        "advance_date": {{ (a.advance_date.isoformat() if a.advance_date else "")|tojson }},
        "amount": {{ ((a.amount or 0)|float)|tojson }},
        "note": {{ (a.note or "")|tojson }}
      }{{ "," if not loop.last else "" }}
      {% endfor %}
    {% endif %}
  ]
}
{% else %}
{
  "id": null,
  "code": "",
  "name": "",
  "description": "",
  "customer_name": "",
  "location": "",
  "start_date": "",
  "end_date": "",
  "work_days": 0,
  "status": "IN_PROGRESS",

  "materials": [],
  "subcontractors": [],
  "expenses": [],
  "advances": []
}
{% endif %}
</script>

<script>
  window.__PROJECT__ = JSON.parse(document.getElementById('project-data').textContent);
</script>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/project_form.js') }}"></script>
{% endblock %}
