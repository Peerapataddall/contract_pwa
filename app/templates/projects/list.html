{% extends 'base.html' %}
{% set title = 'รายการโครงการ' %}

{% block content %}

{# =========================================================
   ✅ LIST PAGE UPDATE
   - Desktop = Table, Mobile = Cards (กัน CSS หลุดบน Render)
   - เพิ่มคอลัมน์ “งบประมาณ” + “กำไร/ขาดทุน”
   - งบประมาณ: p.sales_doc.grand_total (แสดงเมื่อ status=APPROVED)
   - กำไร/ขาดทุน: งบประมาณ - ต้นทุนรวม (ติดลบได้)
   - ✅ FIX: Decimal vs float -> แปลงเป็น float ก่อนคำนวณ (|float)
   ========================================================= #}

<style>
  /* --- Search layout --- */
  .search{
    display: grid;
    grid-template-columns: 1fr auto auto;
    gap: 10px;
    align-items: center;
    margin: 12px 0 14px;
  }
  .search .input{ width: 100%; min-width: 0; }

  /* --- Desktop / Mobile switch (hard enforce) --- */
  .desktop-table{ display: block; }
  .mobile-cards{ display: none; }

  @media (max-width: 820px){
    .search{
      grid-template-columns: 1fr auto;
    }
    .search .btn-ghost{ grid-column: 1 / -1; } /* ปุ่มล้างลงบรรทัดใหม่ */
    .desktop-table{ display: none !important; }
    .mobile-cards{ display: grid !important; gap: 12px; }
  }

  /* --- Mobile card styles (safe even if app.css missing) --- */
  .mcard{
    border-radius: 18px;
    padding: 14px 14px;
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.10);
    backdrop-filter: blur(10px);
  }
  .mcard__row{
    display: grid;
    grid-template-columns: 96px 1fr;
    gap: 12px;
    align-items: start;
    padding: 8px 0;
    border-top: 1px solid rgba(255,255,255,0.08);
  }
  .mcard__row:first-child{
    border-top: 0;
    padding-top: 0;
  }
  .mcard__label{
    font-size: 12px;
    opacity: .72;
  }
  .mcard__value{
    font-weight: 800;
    min-width: 0;
    word-break: break-word;
  }
  .mcard__titlelink{
    display: inline-block;
    font-weight: 900;
    text-decoration: none;
  }
  .mcard__titlelink:hover{ text-decoration: underline; }

  .mcard__actions{
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-top: 12px;
  }
  .mcard__actions .btn{
    width: 100%;
    justify-content: center;
  }

  /* Empty state */
  .empty{
    padding: 18px;
    text-align: center;
    opacity: .75;
  }

  /* Profit/Loss coloring (optional, safe) */
  .pl-pos{ color: rgba(120, 255, 180, .95); }
  .pl-neg{ color: rgba(255, 140, 140, .95); }
</style>

<div class="pagehead">
  <div>
    <h1>รายการโครงการ</h1>
    <div class="muted">ค้นหาได้จาก “ชื่อโครงการ” หรือ “รหัสโครงการ”</div>
  </div>
  <div class="actions">
    <a class="btn btn-primary" href="{{ url_for('pages.project_new') }}">➕ เพิ่มโครงการ</a>
  </div>
</div>

<form class="search" method="get" action="{{ url_for('pages.project_list') }}">
  <input class="input" name="q" value="{{ q }}" placeholder="ค้นหา: ชื่อโครงการ / รหัสโครงการ" />
  <button class="btn" type="submit">ค้นหา</button>
  {% if q %}
    <a class="btn btn-ghost" href="{{ url_for('pages.project_list') }}">ล้าง</a>
  {% endif %}
</form>

<div class="card">

  {# ===== Desktop: table ===== #}
  <div class="table-wrap desktop-table">
    <table class="table">
      <thead>
        <tr>
          <th style="width: 110px;">รหัส</th>
          <th>ชื่อโครงการ</th>
          <th style="width: 140px;">สถานะ</th>
          <th style="width: 140px;" class="right">งบประมาณ</th>
          <th style="width: 140px;" class="right">ต้นทุนรวม</th>
          <th style="width: 150px;" class="right">กำไร/ขาดทุน</th>
          <th style="width: 180px;"></th>
        </tr>
      </thead>
      <tbody>
        {% for p in projects %}

        {# ✅ งบประมาณจาก QT (sales_doc) เฉพาะ APPROVED #}
        {% set _doc = p.sales_doc %}
        {% set _budget = (_doc.grand_total|float) if _doc and (_doc.status or '') == 'APPROVED' else None %}
        {% set _cost = (p.total_cost or 0)|float %}
        {% set _pl = (_budget - _cost) if _budget is not none else None %}

        <tr>
          <td class="mono">{{ p.code }}</td>
          <td>
            <a class="link" href="{{ url_for('pages.project_view', pid=p.id) }}">{{ p.name }}</a>
            {% if p.customer_name %}
              <div class="muted">ลูกค้า: {{ p.customer_name }}</div>
            {% endif %}
          </td>
          <td>
            <span class="pill pill-{{ p.status|lower }}">
              {{ {'IN_PROGRESS':'กำลังทำงาน','DEFECT':'กำลังเก็บ Defect','DONE':'งานจบ'}[p.status] if p.status in ['IN_PROGRESS','DEFECT','DONE'] else p.status }}
            </span>
          </td>

          <td class="right mono">
            {% if _budget is not none %}
              {{ '%.2f'|format(_budget) }}
            {% else %}
              -
            {% endif %}
          </td>

          <td class="right mono">{{ '%.2f'|format(_cost) }}</td>

          <td class="right mono">
            {% if _pl is not none %}
              <span class="{{ 'pl-neg' if _pl < 0 else 'pl-pos' }}">
                {{ '%.2f'|format(_pl) }}
              </span>
            {% else %}
              -
            {% endif %}
          </td>

          <td class="right">
            <a class="btn btn-small" href="{{ url_for('pages.project_edit', pid=p.id) }}">✏️ แก้ไข</a>
          </td>
        </tr>
        {% else %}
        <tr><td colspan="7" class="muted center" style="padding: 18px;">ยังไม่มีข้อมูล</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {# ===== Mobile: card list ===== #}
  <div class="mobile-cards">
    {% for p in projects %}
      {% set _st = (p.status or '') %}

      {% set _doc = p.sales_doc %}
      {% set _budget = (_doc.grand_total|float) if _doc and (_doc.status or '') == 'APPROVED' else None %}
      {% set _cost = (p.total_cost or 0)|float %}
      {% set _pl = (_budget - _cost) if _budget is not none else None %}

      <div class="mcard">

        <div class="mcard__row">
          <div class="mcard__label">รหัส</div>
          <div class="mcard__value mono">{{ p.code }}</div>
        </div>

        <div class="mcard__row">
          <div class="mcard__label">ชื่อโครงการ</div>
          <div class="mcard__value">
            <a class="mcard__titlelink" href="{{ url_for('pages.project_view', pid=p.id) }}">
              {{ p.name }}
            </a>
            {% if p.customer_name %}
              <div class="muted" style="font-weight:800; margin-top:4px;">ลูกค้า: {{ p.customer_name }}</div>
            {% endif %}
          </div>
        </div>

        <div class="mcard__row">
          <div class="mcard__label">สถานะ</div>
          <div class="mcard__value">
            <span class="pill pill-{{ _st|lower }}">
              {{ {'IN_PROGRESS':'กำลังทำงาน','DEFECT':'กำลังเก็บ Defect','DONE':'งานจบ'}[_st] if _st in ['IN_PROGRESS','DEFECT','DONE'] else _st }}
            </span>
          </div>
        </div>

        <div class="mcard__row">
          <div class="mcard__label">งบประมาณ</div>
          <div class="mcard__value right mono">
            {% if _budget is not none %}
              {{ '%.2f'|format(_budget) }}
            {% else %}
              -
            {% endif %}
          </div>
        </div>

        <div class="mcard__row">
          <div class="mcard__label">ต้นทุนรวม</div>
          <div class="mcard__value right mono">{{ '%.2f'|format(_cost) }}</div>
        </div>

        <div class="mcard__row">
          <div class="mcard__label">กำไร/ขาดทุน</div>
          <div class="mcard__value right mono">
            {% if _pl is not none %}
              <span class="{{ 'pl-neg' if _pl < 0 else 'pl-pos' }}">
                {{ '%.2f'|format(_pl) }}
              </span>
            {% else %}
              -
            {% endif %}
          </div>
        </div>

        <div class="mcard__actions">
          <a class="btn btn-small" href="{{ url_for('pages.project_view', pid=p.id) }}">ดู</a>
          <a class="btn btn-small" href="{{ url_for('pages.project_edit', pid=p.id) }}">✏️ แก้ไข</a>
        </div>
      </div>
    {% endfor %}

    {% if not projects %}
      <div class="empty">
        ไม่พบโครงการ
      </div>
    {% endif %}
  </div>

</div>

{% endblock %}
